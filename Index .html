<!doctype html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>音頻儲存 & 播放器</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa6b2;color-scheme:dark}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC',"Noto Sans",sans-serif}
  body{margin:0;background:linear-gradient(180deg,#071029 0%, #071827 100%);color:#e6eef2;min-height:100vh;padding:24px}
  .wrap{max-width:900px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  h1{margin:0;font-size:20px}
  .card{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
  .flex{display:flex;gap:12px;align-items:center}
  input[type=file]{display:none}
  .upload{border:2px dashed rgba(255,255,255,0.06);padding:18px;border-radius:10px;text-align:center;cursor:pointer}
  .list{margin-top:12px;display:grid;gap:8px}
  .item{display:flex;gap:12px;align-items:center;padding:8px;border-radius:8px;background:rgba(0,0,0,0.2)}
  .meta{flex:1;min-width:0}
  .meta h3{margin:0 0 6px 0;font-size:15px}
  .meta p{margin:0;color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  button{background:var(--accent);border:0;padding:8px 10px;border-radius:8px;color:#052024;cursor:pointer}
  small{color:var(--muted)}
  .controls{display:flex;gap:8px}
  .search{margin-left:auto}
  .row{display:flex;gap:8px;align-items:center}
  .danger{background:#ef4444;color:white}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  label.field{display:block;margin-top:8px}
  input[type=text], textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>音頻儲存 & 播放器</h1>
      <small>上傳音檔到瀏覽器儲存（IndexedDB），可播放、編輯標題與說明、下載或匯出資料</small>
    </div>
  </header>  <div class="card">
    <div class="row">
      <label class="upload" id="dropzone">點擊或拖曳音檔到此處
        <input id="file" type="file" accept="audio/*" multiple>
      </label>
      <div style="flex:1">
        <label class="field">標題（預設使用檔名）<input id="title" type="text" placeholder="選填"></label>
        <label class="field">說明<textarea id="desc" rows="2" placeholder="選填"></textarea></label>
      </div>
      <div style="min-width:120px">
        <div class="row" style="flex-direction:column">
          <button id="save">上傳並儲存</button>
          <button id="import" style="margin-top:8px">匯入 JSON</button>
        </div>
      </div>
    </div><div style="display:flex;gap:8px;margin-top:12px;align-items:center">
  <input id="q" placeholder="搜尋標題或名稱" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">
  <button id="export">匯出全部 (.json)</button>
  <button id="clearDb" class="danger">清除全部</button>
</div>

<div class="list" id="list"></div>

  </div>  <footer>
    本地儲存於瀏覽器 IndexedDB，僅在此裝置與瀏覽器可用；想要共享或雲端備份請按「匯出」下載 JSON。
  </footer>
</div><script>
// 簡易 IndexedDB wrapper
const DB_NAME = 'audio-store-db';
const STORE = 'audios';
let db;
function openDB(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB_NAME,1);
    r.onupgradeneeded = e => {
      const d = e.target.result;
      if(!d.objectStoreNames.contains(STORE)){
        const store = d.createObjectStore(STORE,{keyPath:'id'});
        store.createIndex('title','title',{unique:false});
      }
    }
    r.onsuccess = e => {db=e.target.result;res(db)};
    r.onerror = e => rej(e.target.error);
  })
}
function put(item){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(item);
    tx.oncomplete = ()=>res();
    tx.onerror = e=>rej(e.target.error);
  })
}
function getAll(){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readonly');
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = ()=>res(req.result);
    req.onerror = e=>rej(e.target.error);
  })
}
function del(id){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).delete(id);
    tx.oncomplete = ()=>res();
    tx.onerror = e=>rej(e.target.error);
  })
}
function clearDB(){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).clear();
    tx.oncomplete = ()=>res();
    tx.onerror = e=>rej(e.target.error);
  })
}

// helpers
function uid(){return crypto.randomUUID()}
function fmtBytes(n){if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; return (n/1024/1024).toFixed(2)+' MB'}

// UI
const fileInput = document.getElementById('file');
const drop = document.getElementById('dropzone');
const saveBtn = document.getElementById('save');
const titleInput = document.getElementById('title');
const descInput = document.getElementById('desc');
const listEl = document.getElementById('list');
const q = document.getElementById('q');
const exportBtn = document.getElementById('export');
const importBtn = document.getElementById('import');
const clearBtn = document.getElementById('clearDb');
let stagedFiles = [];

// drag & drop
['dragenter','dragover','dragleave','drop'].forEach(ev=>{
  drop.addEventListener(ev,e=>e.preventDefault())
});
drop.addEventListener('drop',async e=>{
  const files = Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('audio'));
  if(files.length) {stagedFiles = files; renderStaged();}
});
drop.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',()=>{stagedFiles = Array.from(fileInput.files).filter(f=>f.type.startsWith('audio')); renderStaged();});

function renderStaged(){
  // show staged files on top of list
  render();
}

async function saveStaged(){
  if(!stagedFiles.length){alert('請先選擇音檔');return}
  for(const f of stagedFiles){
    const arr = await f.arrayBuffer();
    const blob = new Blob([arr],{type:f.type});
    const id = uid();
    const item = {id,title: titleInput.value||f.name,desc:descInput.value||'',name:f.name,size:f.size,type:f.type,created:Date.now(),blob};
    await put(item);
  }
  stagedFiles = [];
  titleInput.value='';descInput.value='';fileInput.value='';
  await render();
}

async function render(){
  const all = await getAll();
  const qv = q.value.trim().toLowerCase();
  const filtered = all.filter(i => !qv || (i.title||'').toLowerCase().includes(qv) || (i.name||'').toLowerCase().includes(qv));
  listEl.innerHTML='';
  // staged files
  for(const f of stagedFiles){
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div class="meta"><h3>${f.name}</h3><p>未儲存 · ${fmtBytes(f.size)}</p></div><div class="controls"><button onclick="____addStaged('${f.name.replace(/'/g,'\'')}')">上傳</button></div>`;
    listEl.appendChild(el);
  }
  // stored
  filtered.sort((a,b)=>b.created-a.created);
  for(const it of filtered){
    const el = document.createElement('div'); el.className='item';
    const info = `<div class="meta"><h3>${escapeHtml(it.title||it.name)}</h3><p>${escapeHtml(it.desc||'')} · ${new Date(it.created).toLocaleString()}</p></div>`;
    el.innerHTML = info + `<div class="controls">
      <button onclick="playAudio('${it.id}')">▶ 播放</button>
      <button onclick="downloadAudio('${it.id}')">⬇ 下載</button>
      <button onclick="editMeta('${it.id}')">編輯</button>
      <button onclick="deleteAudio('${it.id}')" class="danger">刪除</button>
    </div>`;
    listEl.appendChild(el);
  }
}

function escapeHtml(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}

window.playAudio = async function(id){
  const tx = db.transaction(STORE,'readonly');
  const req = tx.objectStore(STORE).get(id);
  req.onsuccess = e => {
    const it = e.target.result;
    if(!it) return alert('找不到音檔');
    const url = URL.createObjectURL(it.blob);
    const a = new Audio(url);
    a.controls = true; a.autoplay = true;
    const w = window.open('','_blank','width=420,height=120');
    w.document.body.style.background='#071827';
    w.document.body.style.color='white';
    w.document.body.appendChild(a);
  }
}

window.downloadAudio = async function(id){
  const tx = db.transaction(STORE,'readonly');
  const req = tx.objectStore(STORE).get(id);
  req.onsuccess = e => {
    const it = e.target.result;
    if(!it) return alert('找不到音檔');
    const url = URL.createObjectURL(it.blob);
    const a = document.createElement('a');
    a.href = url; a.download = it.name || (it.title||'audio');
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),3000);
  }
}

window.editMeta = async function(id){
  const tx = db.transaction(STORE,'readonly');
  const req = tx.objectStore(STORE).get(id);
  req.onsuccess = async e => {
    const it = e.target.result;
    if(!it) return alert('找不到');
    const newTitle = prompt('標題', it.title||it.name)||it.title||it.name;
    const newDesc = prompt('說明', it.desc||'')||it.desc||'';
    it.title = newTitle; it.desc = newDesc;
    await put(it);
    render();
  }
}

window.deleteAudio = async function(id){
  if(!confirm('確定刪除此音檔？')) return;
  await del(id); render();
}

// staged single-add helper (called from innerHTML onclick)
window.____addStaged = async function(name){
  const f = stagedFiles.find(x=>x.name===name);
  if(!f) return alert('找不到該檔案');
  const arr = await f.arrayBuffer();
  const blob = new Blob([arr],{type:f.type});
  const id = uid();
  const item = {id,title: f.name,desc:'',name:f.name,size:f.size,type:f.type,created:Date.now(),blob};
  await put(item);
  stagedFiles = stagedFiles.filter(x=>x.name!==name);
  render();
}

// export / import
exportBtn.addEventListener('click',async ()=>{
  const all = await getAll();
  // convert blobs to base64
  const out = [];
  for(const it of all){
    const buf = await it.blob.arrayBuffer();
    const b64 = arrayBufferToBase64(buf);
    out.push({...it,blob:b64});
  }
  const blob = new Blob([JSON.stringify(out)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'audios.json'; document.body.appendChild(a); a.click(); a.remove();
});

importBtn.addEventListener('click',()=>{
  const f = document.createElement('input'); f.type='file'; f.accept='application/json';
  f.onchange = async ()=>{
    const file = f.files[0]; if(!file) return;
    const txt = await file.text();
    try{
      const arr = JSON.parse(txt);
      for(const it of arr){
        const buf = base64ToArrayBuffer(it.blob);
        const blob = new Blob([buf],{type:it.type||'audio/*'});
        const newid = it.id || uid();
        await put({id:newid,title:it.title||it.name,desc:it.desc||'',name:it.name||'audio',size:it.size||blob.size,type:it.type||blob.type,created:it.created||Date.now(),blob});
      }
      render();
      alert('匯入完成');
    }catch(e){alert('匯入失敗:'+e.message)}
  }
  f.click();
});

clearBtn.addEventListener('click',async ()=>{if(confirm('清除後無法復原，確定？')){await clearDB();render();}});

q.addEventListener('input',()=>render());
saveBtn.addEventListener('click',saveStaged);

// base64 helpers
function arrayBufferToBase64(buffer){
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const chunk = 0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
  }
  return btoa(binary);
}
function base64ToArrayBuffer(base64){
  const binary = atob(base64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for(let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i);
  return bytes.buffer;
}

// init
openDB().then(()=>render()).catch(e=>alert('IndexedDB 初始化失敗: '+e.message));

</script></body>
</html>
